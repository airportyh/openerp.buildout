[buildout]
extensions = buildout.bootstrap
extends =
#    openerp-trunk.cfg
    openerp-6.0.cfg
#    openerp-custom.cfg
relative-paths = true
unzip = true
versions = versions
parts =
    mocked-eggs
    system-init
    timezone-setup
    postgresql-install
    openerp
    openerp-server
    openerp-config


[versions]
lxml = 2.1.5


[mocked-eggs]
recipe = collective.recipe.mockedeggs
mocked-eggs =
    lxml = 2.1.5


[system-init]
recipe = collective.recipe.cmd
on_install = true
on_update = true
cmds =
    # Stop all previous processes
    kill `ps -ef | grep openerp-shell | awk '{print $2}'`
    /etc/init.d/postgresql stop
    # Install required packages
    apt-get update
    apt-get -y install sudo bzr subversion python-lxml python-psycopg2 python-reportlab python-egenix-mxdatetime python-imaging python-vobject
    # Patch Debian Squeeze's Bazaar to let it work through a proxy
    # See: http://bugs.launchpad.net/bzr/+bug/558343
    test `lsb_release --codename --short` = 'squeeze' && dpkg --list bzr | grep --quiet '2.1.2-1' && echo patch --forward -p0 -d /usr/share/pyshared < ${buildout:directory}/patches/bzr-2.1.2-1-debian-squeeze-proxy.patch || echo 'No need to patch Bazaar'


[timezone-setup]
# Source: http://serverfault.com/questions/84521/automate-dpkg-reconfigure-tzdata
recipe = collective.recipe.cmd
on_install = true
on_update = true
cmds =
    echo "Etc/UTC" > /etc/timezone
    dpkg-reconfigure -f noninteractive tzdata


[postgresql-install]
recipe = collective.recipe.cmd
on_install = true
on_update = true
cmds =
    # Install PosgreSQL package
    apt-get -y install postgresql
    # Allow local authentication
    sed -i 's/^local\s\+all\s\+all\s\+ident/local all all trust/g' /etc/postgresql/8.4/main/pg_hba.conf
    sed -i 's/^host\s\+all\s\+all\s\+\(.*\)\s\+md5/host all all \1 trust/g' /etc/postgresql/8.4/main/pg_hba.conf
    # Activate autovacuum
    sed -i 's/^#autovacuum = on/autovacuum = on/g' /etc/postgresql/8.4/main/postgresql.conf
    # Set timezone to maintain consistency
    sed -i 's/^#timezone = unknown/timezone = UTC/g' /etc/postgresql/8.4/main/postgresql.conf
    # Restart the server to apply our configuration above
    /etc/init.d/postgresql restart
    # Create a default openerp user and database
    su postgres -c "createuser --createdb --no-createrole --superuser --no-password openerp"


[openerp]
recipe = gf.recipe.bzr
in_parts = True
develop = False
# Custom variables
location = ${buildout:directory}/parts/openerp/
#addon_list =


[openerp-config]
recipe = collective.recipe.cmd
on_install = true
on_update = true
cmds +=
    # Recreate all addons symlinks everytime to keep a fresh module list
    mkdir -p ${openerp:location}/server/bin/addons
    find ${openerp:location}/server/bin/addons -type l -delete
    for ADDONS in `echo "${openerp:addon_list}"` ; do find ${openerp:location}/$ADDONS -maxdepth 0 -type d | xargs -I {} ln -s --force {} ${openerp:location}/server/bin/addons/ ; done
    # OpenERP refuse to run as root, let's create a dedicated user
    useradd --create-home openerp
    su openerp -c "${buildout:directory}/bin/${openerp-server:interpreter} ${openerp:location}/server/bin/openerp-server.py -s --stop-after-init -u all"
    # The initial /home/openerp/.openerp_serverrc generated by the command above will not let you run the server until we configure it properly. Let's remove it until we do.
    rm -f /home/openerp/.openerp_serverrc
    # /server/bin is not seen as a module and we'll not be able to let zc.recipe.egg create a command script, unless we create an init script.
    #touch ${openerp:location}/server/bin/__init__.py


[openerp-server]
recipe = zc.recipe.egg:scripts
eggs =
    pyparsing
    xlwt
    setuptools
    PyChart
    pydot
    caldav
    PyYAML
    PyWebDAV
    feedparser
    CherryPy == 3.1.2
    Mako >= 0.2.4
    Babel >= 0.9.4
    FormEncode >= 1.2.2
    simplejson >= 2.0.9
    python-dateutil >= 1.4.1
    pytz >= 2009j
extra-paths =
    ${openerp:location}/server/bin
    ${openerp:location}/web-client
interpreter = openerp-shell
#entry-points = openerp-server.py=openerp-server.py:main

